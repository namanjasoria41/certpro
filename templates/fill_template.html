{% extends "base.html" %}
{% block title %}Fill Template â€” {{ template.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>
body {
    background: linear-gradient(180deg,#041a47,#00112c);
    color:white;
}

.container-box {
    max-width: 480px;
    margin: auto;
    padding: 20px;
}

/* IMAGE BOX */
.photo-upload-box {
    width: 140px;
    height: 140px;
    border: 2px dashed rgba(255,255,255,.4);
    border-radius: 14px;
    display:flex;
    justify-content:center;
    align-items:center;
    cursor:pointer;
    margin: 16px auto;
}
.photo-upload-box img {
    width:100%;
    height:100%;
    object-fit:cover;
    border-radius:14px;
    display:none;
}

/* INPUT */
.input-line {
    width:100%;
    background:transparent;
    border:none;
    border-bottom:2px solid rgba(255,255,255,.3);
    color:white;
    padding:6px 0;
    margin-bottom:14px;
}

/* BUTTON */
.create-btn {
    width:100%;
    padding:14px;
    background:linear-gradient(90deg,#ffb000,#ff9000);
    border:none;
    border-radius:12px;
    font-size:18px;
    font-weight:700;
}

/* ===== CROP SCREEN ===== */
.crop-screen {
    position:fixed;
    inset:0;
    background:#0b1020;
    z-index:9999;
    display:none;
    flex-direction:column;
}

.crop-header {
    padding:12px;
    font-weight:700;
    text-align:center;
    border-bottom:1px solid rgba(255,255,255,.1);
}

.crop-body {
    display:flex;
    gap:12px;
    padding:12px;
    flex:1;
}

.crop-left {
    flex:2;
}
.crop-right {
    flex:1;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:10px;
}

.preview-box {
    width:140px;
    height:140px;
    border-radius:14px;
    overflow:hidden;
    border:2px solid #ffb000;
}
.preview-box.circle {
    border-radius:50%;
}

.preview-box img {
    width:100%;
    height:100%;
    object-fit:cover;
}

.crop-footer {
    padding:12px;
    display:flex;
    gap:10px;
}

.crop-footer button {
    flex:1;
    padding:10px;
    border:none;
    border-radius:10px;
    font-weight:600;
}
</style>
{% endblock %}

{% block content %}
<div class="container-box">

<h4 style="text-align:center">{{ template.name }}</h4>

<form method="POST" action="{{ url_for('fill_template', template_id=template.id) }}">

{% for f in fields %}

{% if f.field_type == "text" %}
<label>{{ f.field_name|capitalize }}</label>
<input class="input-line" name="{{ f.field_name }}">
{% endif %}

{% if f.field_type == "image" %}
<label>{{ f.field_name|capitalize }}</label>

<div class="photo-upload-box" onclick="openFile('{{ f.field_name }}')">
    <img id="final_{{ f.field_name }}">
    <span>ðŸ“·</span>
</div>

<input type="file" id="file_{{ f.field_name }}" hidden accept="image/*"
       onchange="startCrop(event,'{{ f.field_name }}','{{ f.shape }}')">

<input type="hidden" name="{{ f.field_name }}" id="hidden_{{ f.field_name }}">
{% endif %}

{% endfor %}

<button class="create-btn">CREATE</button>
</form>
</div>

<!-- ===== FULL CROP SCREEN ===== -->
<div id="cropScreen" class="crop-screen">
    <div class="crop-header">Adjust Image</div>

    <div class="crop-body">
        <div class="crop-left">
            <img id="cropImage" style="max-width:100%">
        </div>

        <div class="crop-right">
            <div id="previewBox" class="preview-box">
                <img id="livePreview">
            </div>
            <small>Live Preview</small>
        </div>
    </div>

    <div class="crop-footer">
        <button onclick="cancelCrop()" style="background:#444;color:white">Cancel</button>
        <button onclick="applyCrop()" style="background:#ffb000">Apply</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper, currentField, currentShape;

function openFile(field) {
    const i = document.getElementById("file_"+field);
    i.value="";
    i.click();
}

function startCrop(e, field, shape) {
    currentField = field;
    currentShape = shape;

    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = ev => {
        document.getElementById("cropScreen").style.display="flex";
        document.getElementById("cropImage").src = ev.target.result;
        document.getElementById("livePreview").src = ev.target.result;

        const pb = document.getElementById("previewBox");
        pb.classList.toggle("circle", shape==="circle");

        if(cropper) cropper.destroy();
        cropper = new Cropper(cropImage,{
            aspectRatio: shape==="circle"?1:NaN,
            viewMode:1,
            autoCropArea:1,
            crop(){
                const canvas = cropper.getCroppedCanvas({width:300,height:300});
                livePreview.src = canvas.toDataURL();
            }
        });
    };
    reader.readAsDataURL(file);
}

function applyCrop() {
    let canvas = cropper.getCroppedCanvas();

    if(currentShape==="circle"){
        const s = Math.min(canvas.width,canvas.height);
        const c = document.createElement("canvas");
        c.width=s; c.height=s;
        const ctx=c.getContext("2d");
        ctx.beginPath();
        ctx.arc(s/2,s/2,s/2,0,Math.PI*2);
        ctx.clip();
        ctx.drawImage(canvas,0,0,s,s);
        canvas=c;
    }

    const base64 = canvas.toDataURL("image/png");
    document.getElementById("final_"+currentField).src = base64;
    document.getElementById("final_"+currentField).style.display="block";
    document.getElementById("hidden_"+currentField).value = base64;

    closeCrop();
}

function cancelCrop(){ closeCrop(); }

function closeCrop(){
    document.getElementById("cropScreen").style.display="none";
    if(cropper) cropper.destroy();
    cropper=null;
}
</script>
{% endblock %}

