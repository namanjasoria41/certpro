{% extends "base.html" %}

{% block title %}Fill Template â€” {{ template.name }}{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">

<style>

    body {
        background: linear-gradient(180deg, #041a47, #00112c);
        color: white;
    }

    .container-box {
        padding: 20px;
        max-width: 450px;
        margin: auto;
    }

    /* HEADER */
    .header-title {
        text-align: center;
        font-size: 22px;
        font-weight: 700;
        margin-top: 10px;
    }

    .subtitle {
        text-align: center;
        font-size: 14px;
        opacity: .8;
    }

    /* TOGGLE BUTTONS */
    .toggle-box {
        display: flex;
        background: rgba(255,255,255,0.1);
        border-radius: 12px;
        margin: 20px 0;
    }

    .toggle-btn {
        flex: 1;
        padding: 10px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        border-radius: 12px;
        transition: .2s;
    }

    .active-tab {
        background: #ff9c00;
        color: #000;
    }

    /* TOP UPLINES SECTION */
    .uplines-box {
        background: rgba(255,255,255,0.08);
        padding: 12px;
        border-radius: 12px;
        margin-bottom: 16px;
    }

    .uplines-list {
        display: flex;
        gap: 10px;
        overflow-x: auto;
    }

    .uplines-item {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: 2px solid #ffb300;
        overflow: hidden;
    }

    .uplines-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .plus-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: rgba(255,255,255,0.15);
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 26px;
        cursor: pointer;
    }

    /* FORM INPUTS */
    .field-label {
        margin-top: 10px;
        font-size: 14px;
        font-weight: 600;
    }

    .input-line {
        width: 100%;
        background: transparent;
        border: none;
        border-bottom: 2px solid rgba(255,255,255,0.3);
        padding: 8px 0;
        color: white;
        outline: none;
        margin-bottom: 15px;
        font-size: 15px;
    }

    /* IMAGE UPLOAD BOX */
    .photo-upload-box {
        margin: 20px auto;
        width: 130px;
        height: 130px;
        border: 2px dashed rgba(255,255,255,0.4);
        border-radius: 12px;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        cursor: pointer;
    }

    .photo-upload-box img {
        width: 100%;
        height: 100%;
        border-radius: 12px;
        object-fit: cover;
        display: none;
    }

    .upload-icon {
        font-size: 40px;
        opacity: 0.7;
    }

    /* CREATE BUTTON */
    .create-btn {
        width: 100%;
        margin-top: 20px;
        padding: 14px;
        background: linear-gradient(90deg, #ffb000, #ff9000);
        border: none;
        border-radius: 12px;
        color: #000;
        font-weight: 700;
        font-size: 18px;
        cursor: pointer;
    }

    /* CROPPER MODAL */
    .cropper-modal {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        z-index: 5000;
        justify-content: center;
        align-items: center;
    }

    .cropper-box {
        background: #111;
        padding: 20px;
        border-radius: 12px;
        max-width: 95%;
    }

</style>
{% endblock %}



{% block content %}

<div class="container-box">

    <!-- HEADER -->
    <div class="header-title">{{ template.name }}</div>
    <div class="subtitle">Achiever Details</div>

    <!-- TOGGLE -->
    <div class="toggle-box">
        <div class="toggle-btn active-tab">With My Photo</div>
        <div class="toggle-btn">With Others</div>
    </div>

    <!-- UPLINES -->
    <div class="uplines-box">
        <div class="uplines-list">
            <!-- Sample demo avatars -->
            <div class="uplines-item"><img src="/static/default_avatar1.png"></div>
            <div class="uplines-item"><img src="/static/default_avatar2.png"></div>
            <div class="uplines-item"><img src="/static/default_avatar3.png"></div>
            <div class="plus-btn">+</div>
        </div>
    </div>

    <form action="{{ url_for('fill_template', template_id=template.id) }}" method="POST">

        {% for f in fields %}
        {% if f.field_type == "text" %}
            <label class="field-label">{{ f.field_name|capitalize }}</label>
            <input type="text" name="{{ f.field_name }}" class="input-line" placeholder="Enter {{ f.field_name }}">
        {% endif %}

        {% if f.field_type == "image" %}
            <label class="field-label">{{ f.field_name|capitalize }}</label>

            <div class="photo-upload-box" onclick="document.getElementById('file_{{ f.field_name }}').click()">
                <img id="preview_{{ f.field_name }}">
                <span class="upload-icon">ðŸ“·</span>
            </div>

            <input type="file" id="file_{{ f.field_name }}" accept="image/*" style="display:none"
                   onchange="openCropper(event, '{{ f.field_name }}', '{{ f.shape }}')">

            <input type="hidden" name="{{ f.field_name }}" id="hidden_{{ f.field_name }}">
        {% endif %}
        {% endfor %}

        <button type="submit" class="create-btn">CREATE</button>

    </form>

</div>



<!-- CROPPER POPUP -->
<div id="cropperModal" class="cropper-modal">
    <div class="cropper-box">
        <h4 style="color:white; text-align:center;">Adjust Your Photo</h4>

        <img id="cropperImage" style="max-width:100%;">

        <div style="text-align:center; margin-top:10px;">
            <button onclick="cropper.zoom(0.1)" class="btn btn-light">Zoom +</button>
            <button onclick="cropper.zoom(-0.1)" class="btn btn-light">Zoom âˆ’</button>
            <button onclick="applyCrop()" class="btn btn-success">Apply</button>
            <button onclick="closeCropper()" class="btn btn-danger">Cancel</button>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper = null;
let currentField = null;
let currentShape = null;

/*** OPEN CROPPER ***/
function openCropper(event, fieldName, shape) {
    currentField = fieldName;
    currentShape = shape;

    const file = event.target.files[0];
    const reader = new FileReader();

    reader.onload = e => {
        document.getElementById("cropperImage").src = e.target.result;
        document.getElementById("cropperModal").style.display = "flex";

        if (cropper) cropper.destroy();

        cropper = new Cropper(document.getElementById("cropperImage"), {
            aspectRatio: shape === "circle" ? 1 : NaN,
            viewMode: 1,
            autoCropArea: 1,
            background: false
        });
    };

    reader.readAsDataURL(file);
}

/*** APPLY CROPPED IMAGE ***/
function applyCrop() {
    let canvas = cropper.getCroppedCanvas();

    if (currentShape === "circle") {
        const size = Math.min(canvas.width, canvas.height);

        const circleCanvas = document.createElement("canvas");
        circleCanvas.width = size;
        circleCanvas.height = size;

        const ctx = circleCanvas.getContext("2d");

        ctx.beginPath();
        ctx.arc(size/2, size/2, size/2, 0, Math.PI * 2);
        ctx.closePath();
        ctx.clip();

        ctx.drawImage(canvas, 0, 0, size, size);

        canvas = circleCanvas;
    }

    const base64 = canvas.toDataURL("image/png");

    document.getElementById("preview_" + currentField).src = base64;
    document.getElementById("preview_" + currentField).style.display = "block";

    document.getElementById("hidden_" + currentField).value = base64;

    closeCropper();
}

/*** CLOSE MODAL ***/
function closeCropper() {
    document.getElementById("cropperModal").style.display = "none";
    if (cropper) cropper.destroy();
    cropper = null;
}
</script>

{% endblock %}
