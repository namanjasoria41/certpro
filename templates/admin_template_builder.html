{% extends "base.html" %}
{% block title %}Builder - {{ template.name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-3">Template Builder — {{ template.name }}</h3>
    <a href="{{ url_for('admin_templates') }}" class="btn btn-outline-secondary btn-sm">← Back to templates</a>
  </div>

  <div class="row">
    <div class="col-lg-7 mb-4">
      <div class="card">
        <div class="card-body">
          <p class="small text-muted">Click anywhere on the image to get coordinates placed into the "New field" X/Y inputs.</p>

          <div class="text-center border rounded" style="position:relative; overflow:hidden;">
            {% if template.image_path %}
              <img id="templateImage"
                   src="{{ url_for('static', filename='templates/' + template.image_path) }}"
                   alt="{{ template.name }}"
                   class="img-fluid"
                   style="max-height:700px; cursor:crosshair;"
                   />
            {% else %}
              <div class="p-5 text-muted">No image assigned to this template.</div>
            {% endif %}
          </div>

          <div id="clickCoords" class="mt-2 text-muted small"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Fields (visual text placeholders)</h5>
          <div id="fieldsList" class="mb-3">
            <!-- JS populates existing fields -->
          </div>

          <hr />

          <h6 class="mb-2">Add / Edit Field</h6>
          <form id="fieldForm" onsubmit="return false;">
            <input type="hidden" id="editIndex" value="-1" />

            <div class="mb-2">
              <label class="form-label">Field name (key)</label>
              <input id="fieldName" class="form-control" placeholder="e.g. student_name" />
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label">X</label>
                <input id="fieldX" class="form-control" type="number" />
              </div>
              <div class="col-6">
                <label class="form-label">Y</label>
                <input id="fieldY" class="form-control" type="number" />
              </div>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label">Font size</label>
                <input id="fieldFont" class="form-control" type="number" value="24" />
              </div>
              <div class="col-6">
                <label class="form-label">Align</label>
                <select id="fieldAlign" class="form-select">
                  <option value="left">left</option>
                  <option value="center">center</option>
                  <option value="right">right</option>
                </select>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Color (hex)</label>
              <input id="fieldColor" class="form-control" placeholder="#000000" />
            </div>

            <div class="d-flex gap-2">
              <button id="addUpdateBtn" class="btn btn-primary">Add field</button>
              <button id="clearBtn" class="btn btn-outline-secondary" type="button">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <strong class="me-2">Actions</strong>
            <div class="small text-muted">Save will write fields to DB for this template.</div>
          </div>

          <div>
            <button id="saveBtn" class="btn btn-success" onclick="builderSave()">Save</button>
            <a href="{{ url_for('admin_templates') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
          </div>
        </div>
      </div>

      <div id="alertPlaceholder" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
// assume existingFields and templateId already set as before

async function postTo(url, bodyObj) {
  // try sending JSON first
  try {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj),
    });
    const data = await r.json().catch(()=>({}));
    return { ok: r.ok, status: r.status, data };
  } catch (e) {
    console.warn("JSON POST failed to", url, e);
  }

  // fallback: send as form-encoded 'fields' param
  try {
    const form = new URLSearchParams();
    form.append("fields", JSON.stringify(bodyObj.fields || []));
    const r2 = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: form.toString(),
    });
    const data2 = await r2.json().catch(()=>({}));
    return { ok: r2.ok, status: r2.status, data: data2 };
  } catch (e2) {
    console.warn("Form POST failed to", url, e2);
    return { ok: false, status: 0, data: {} };
  }
}

async function builderSave() {
  const payload = { fields: existingFields };

  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';

  const endpoints = [
    `/admin/template/${templateId}/builder`,
    `/admin/templates/${templateId}/fields`  // compatibility
  ];

  let lastErr = null;
  for (const ep of endpoints) {
    try {
      const res = await postTo(ep, payload);
      if (res.ok && res.data && (res.data.status === 'ok' || res.data.status === 'success')) {
        showAlert('Fields saved successfully', 'success');
        setTimeout(()=> location.reload(), 700);
        return;
      } else {
        lastErr = res;
        console.warn("save attempt failed", ep, res);
        // If 404 specifically, continue to next endpoint
        if (res.status === 404) continue;
      }
    } catch (err) {
      console.error("Error posting to", ep, err);
      lastErr = err;
    }
  }

  // If we get here, all endpoints failed
  let msg = "Save failed.";
  if (lastErr && lastErr.data && lastErr.data.message) msg += " " + lastErr.data.message;
  showAlert(msg, 'danger');
  btn.disabled = false;
  btn.textContent = 'Save';
}
</script>

{% endblock %}

