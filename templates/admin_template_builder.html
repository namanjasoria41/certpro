<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Template Builder — {{ template.name }}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background:#0f0210; color:#ddd; }
    .builder-wrapper { display:flex; gap:24px; padding:24px; }
    .canvas-card { flex:1; background: rgba(255,255,255,0.02); padding:16px; border-radius:12px; }
    .sidebar { width:420px; background: rgba(0,0,0,0.25); padding:18px; border-radius:12px; }
    .template-img { width:100%; border-radius:8px; display:block; }
    .placeholder { position:absolute; border:1px dashed rgba(255,255,255,0.35); padding:6px 10px; border-radius:6px; transform: translate(-50%, -50%); pointer-events:none; background: rgba(0,0,0,0.25); }
    .field-list { max-height:340px; overflow:auto; }
    label.small { font-size:0.85rem; color:#9aa; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="py-3 d-flex justify-content-between align-items-center">
      <h2 class="text-light">Template Builder — {{ template.name }}</h2>
      <div>
        <a class="btn btn-outline-light" href="{{ url_for('admin_templates') }}">← Back to Templates</a>
      </div>
    </div>

    <div class="builder-wrapper">
      <div class="canvas-card position-relative">
        <p class="small text-muted">Click anywhere on the image to capture natural pixel coordinates (top-left = 0,0).</p>

        <!-- Template image; use the serve_template_image route to ensure DB fallback works -->
        <div id="canvas-container" style="position:relative;">
          <img id="template-image" class="template-img" src="{{ template_image_url }}" alt="template image" crossorigin="anonymous">
          <!-- placeholders will be inserted here -->
        </div>
      </div>

      <div class="sidebar">
        <h5>Fields (visual placeholders)</h5>
        <div class="mb-3">
          <label class="small">Add / Edit Field</label>
          <input id="field-key" class="form-control mb-2" placeholder="Field key (field_name) — e.g. student_name" />
          <div class="d-flex gap-2 mb-2">
            <input id="field-x" class="form-control" placeholder="X (natural px)">
            <input id="field-y" class="form-control" placeholder="Y (natural px)">
          </div>

          <label class="small">Field type</label>
          <select id="field-type" class="form-select mb-2">
            <option value="text">Text</option>
            <option value="image">Image (upload)</option>
          </select>

          <div class="d-flex gap-2 mb-2">
            <div style="flex:1">
              <label class="small">Font family</label>
              <select id="field-font" class="form-select">
                <option value="default">Default</option>
                <option value="inter">Inter</option>
                <option value="roboto">Roboto</option>
                <option value="open_sans">Open Sans</option>
                <option value="noto_sans">Noto Sans</option>
                <option value="times">Times</option>
                <option value="arial">Arial</option>
              </select>
            </div>
            <div style="width:110px">
              <label class="small">Font size</label>
              <input id="field-size" type="number" min="6" class="form-control" value="24" />
            </div>
          </div>

          <div class="d-flex gap-2 mb-2">
            <div style="flex:1">
              <label class="small">Color</label>
              <input id="field-color" class="form-control" value="#000000" />
            </div>
            <div style="width:140px">
              <label class="small">Align</label>
              <select id="field-align" class="form-select">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </div>
          </div>

          <div id="image-options" style="display:none;">
            <div class="d-flex gap-2 mb-2">
              <input id="field-width" class="form-control" placeholder="Width px" />
              <input id="field-height" class="form-control" placeholder="Height px" />
            </div>
            <label class="small">Shape</label>
            <select id="field-shape" class="form-select mb-2">
              <option value="rect">Rect</option>
              <option value="circle">Circle</option>
            </select>
          </div>

          <div class="d-flex gap-2">
            <button id="add-field-btn" class="btn btn-success">Add / Update Field</button>
            <button id="clear-curr-btn" class="btn btn-secondary">Clear</button>
          </div>
        </div>

        <hr />

        <div>
          <label class="small">Existing fields</label>
          <div class="field-list list-group mb-3" id="fields-list"></div>
          <div class="d-flex gap-2">
            <button id="save-fields-btn" class="btn btn-primary">Save all fields</button>
            <button id="export-json-btn" class="btn btn-outline-light">Export JSON</button>
          </div>
        </div>

        <div class="mt-3">
          <small class="text-muted">Tip: click the image to auto-populate X,Y. For image fields, users can upload files in preview/fill flows.</small>
        </div>
      </div>
    </div>
  </div>

  <script>
    const initialFields = {{ fields|tojson }};
    const templateId = {{ template.id }};
    let fields = JSON.parse(JSON.stringify(initialFields || []));

    const container = document.getElementById('canvas-container');
    const templateImage = document.getElementById('template-image');

    // create placeholder elements for each field
    function renderPlaceholders() {
      // remove existing placeholders
      document.querySelectorAll('.placeholder').forEach(el => el.remove());
      for (const f of fields) {
        const el = document.createElement('div');
        el.className = 'placeholder';
        el.style.left = (f.x || 0) + 'px';
        el.style.top = (f.y || 0) + 'px';
        el.innerText = (f.name || f.field_name || f.field_key || 'field') + (f.field_type === 'image' ? ' (img)' : '');
        container.appendChild(el);
      }
    }

    // populate fields list
    function renderFieldsList() {
      const list = document.getElementById('fields-list');
      list.innerHTML = '';
      fields.forEach((f, i) => {
        const item = document.createElement('div');
        item.className = 'list-group-item bg-transparent d-flex justify-content-between align-items-start';
        item.innerHTML = `
          <div>
            <strong>${f.field_name || f.name}</strong><br/>
            <small class="text-muted">${f.field_type} — x:${f.x} y:${f.y} size:${f.font_size} font:${f.font_family}</small>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-outline-light btn-edit" data-index="${i}">Edit</button>
            <button class="btn btn-sm btn-outline-danger btn-del" data-index="${i}">Del</button>
          </div>
        `;
        list.appendChild(item);
      });
      // attach handlers
      document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', e => {
        const idx = parseInt(e.currentTarget.dataset.index);
        loadFieldIntoForm(fields[idx]);
      }));
      document.querySelectorAll('.btn-del').forEach(b => b.addEventListener('click', e => {
        const idx = parseInt(e.currentTarget.dataset.index);
        if (confirm('Delete field?')) {
          fields.splice(idx, 1);
          renderPlaceholders();
          renderFieldsList();
        }
      }));
    }

    function loadFieldIntoForm(f) {
      document.getElementById('field-key').value = f.field_name || f.name || '';
      document.getElementById('field-x').value = f.x || 0;
      document.getElementById('field-y').value = f.y || 0;
      document.getElementById('field-size').value = f.font_size || 24;
      document.getElementById('field-color').value = f.color || '#000000';
      document.getElementById('field-align').value = f.align || 'left';
      document.getElementById('field-type').value = f.field_type || 'text';
      document.getElementById('field-font').value = f.font_family || 'default';
      document.getElementById('field-width').value = f.width || '';
      document.getElementById('field-height').value = f.height || '';
      document.getElementById('field-shape').value = f.shape || 'rect';
      toggleImageOptions();
    }

    function clearForm() {
      document.getElementById('field-key').value = '';
      document.getElementById('field-x').value = '';
      document.getElementById('field-y').value = '';
      document.getElementById('field-size').value = 24;
      document.getElementById('field-color').value = '#000000';
      document.getElementById('field-align').value = 'left';
      document.getElementById('field-type').value = 'text';
      document.getElementById('field-font').value = 'default';
      document.getElementById('field-width').value = '';
      document.getElementById('field-height').value = '';
      document.getElementById('field-shape').value = 'rect';
      toggleImageOptions();
    }

    // image click -> coordinates mapping (natural px)
    templateImage.addEventListener('click', function(ev) {
      const rect = templateImage.getBoundingClientRect();
      // calculate click relative to top-left of image in natural pixels
      const clickX = ev.clientX - rect.left;
      const clickY = ev.clientY - rect.top;
      // The above are css pixels; to map to natural image pixels:
      const scaleX = templateImage.naturalWidth / rect.width;
      const scaleY = templateImage.naturalHeight / rect.height;
      const naturalX = Math.round(clickX * scaleX);
      const naturalY = Math.round(clickY * scaleY);

      // auto-fill form fields
      document.getElementById('field-x').value = naturalX;
      document.getElementById('field-y').value = naturalY;
    });

    document.getElementById('field-type').addEventListener('change', toggleImageOptions);
    function toggleImageOptions() {
      const t = document.getElementById('field-type').value;
      document.getElementById('image-options').style.display = (t === 'image') ? 'block' : 'none';
    }

    document.getElementById('add-field-btn').addEventListener('click', function() {
      const key = document.getElementById('field-key').value.trim();
      if (!key) { alert('Field key required'); return; }
      const x = parseInt(document.getElementById('field-x').value || 0);
      const y = parseInt(document.getElementById('field-y').value || 0);
      const font_size = parseInt(document.getElementById('field-size').value || 24);
      const color = document.getElementById('field-color').value || '#000000';
      const align = document.getElementById('field-align').value || 'left';
      const field_type = document.getElementById('field-type').value || 'text';
      const font_family = document.getElementById('field-font').value || 'default';
      const width = document.getElementById('field-width').value || null;
      const height = document.getElementById('field-height').value || null;
      const shape = document.getElementById('field-shape').value || 'rect';

      // update if exists
      const idx = fields.findIndex(f => (f.field_name || f.name) === key);
      const obj = {
        field_name: key,
        name: key,
        x: x,
        y: y,
        font_size: font_size,
        color: color,
        align: align,
        field_type: field_type,
        font_family: font_family,
        width: width ? parseInt(width) : null,
        height: height ? parseInt(height) : null,
        shape: shape
      };

      if (idx >= 0) {
        fields[idx] = Object.assign({}, fields[idx], obj);
      } else {
        fields.push(obj);
      }

      renderPlaceholders();
      renderFieldsList();
      clearForm();
    });

    document.getElementById('clear-curr-btn').addEventListener('click', function() {
      clearForm();
    });

    document.getElementById('save-fields-btn').addEventListener('click', function() {
      // send fields to server
      fetch(`/admin/template/${templateId}/builder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ fields: fields })
      }).then(r => r.json()).then(data => {
        if (data && data.status === 'ok') {
          alert('Fields saved.');
          // reload to get fresh normalized fields from server
          location.reload();
        } else {
          alert('Save failed: ' + (data && data.message ? data.message : 'unknown'));
        }
      }).catch(err => {
        console.error(err);
        alert('Save failed: network or server error');
      });
    });

    document.getElementById('export-json-btn').addEventListener('click', function() {
      const blob = new Blob([JSON.stringify(fields, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `template_${templateId}_fields.json`;
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    // initial render
    renderPlaceholders();
    renderFieldsList();
    clearForm();
  </script>
</body>
</html>

