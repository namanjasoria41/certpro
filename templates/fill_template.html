{% extends "base.html" %}
{% block title %}Create {{ template.name }}{% endblock %}

{% block content %}
<div class="main-container">

  <h3 class="text-center mb-2">{{ template.name }}</h3>
  <p class="text-center text-muted">Fill details & upload images</p>

  <form method="POST">

    {% for f in fields %}

      {% if f.field_type == "text" %}
        <label class="mt-3">{{ f.field_name|capitalize }}</label>
        <input class="form-control" name="{{ f.field_name }}" required>
      {% endif %}

      {% if f.field_type == "image" %}
        <label class="mt-4">{{ f.field_name|capitalize }}</label>

        <div class="card p-3 text-center">

          <!-- hidden file picker -->
          <input
            type="file"
            accept="image/*"
            id="file_{{ f.field_name }}"
            hidden
            onchange="handleImagePick(event, '{{ f.field_name }}')"
          >

          {% if session.get('preview_info', {}).get('asset_map', {}).get(f.field_name) %}
            <img
              src="{{ url_for('view_preview',
                filename=session.preview_info.asset_map[f.field_name].split('/')[-1]) }}"
              class="img-fluid rounded mb-2"
            >
            <button type="button"
              class="btn btn-outline-primary btn-sm"
              onclick="document.getElementById('file_{{ f.field_name }}').click()">
              Re-Crop Image
            </button>
          {% else %}
            <button type="button"
              class="btn btn-outline-primary"
              onclick="document.getElementById('file_{{ f.field_name }}').click()">
              Add & Crop Image
            </button>
          {% endif %}

        </div>
      {% endif %}

    {% endfor %}

    <button class="btn btn-primary w-100 mt-4">
      Generate Preview â†’
    </button>

  </form>
</div>

<script>
function handleImagePick(event, fieldName) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        sessionStorage.setItem("crop_image_data", e.target.result);
        window.location.href =
          `/template/{{ template.id }}/crop/${fieldName}`;
    };
    reader.readAsDataURL(file);
}
</script>
{% endblock %}

