{% extends "base.html" %}
{% block title %}Builder - {{ template.name }}{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex align-items-center mb-3">
    <h3 class="me-3">Template Builder — {{ template.name }}</h3>
    <a href="{{ url_for('admin_templates') }}" class="btn btn-outline-secondary btn-sm">← Back to templates</a>
  </div>

  <div class="row">
    <div class="col-lg-7 mb-4">
      <div class="card">
        <div class="card-body">
          <p class="small text-muted">Click anywhere on the image to get coordinates placed into the "New field" X/Y inputs.</p>

          <div id="imgWrap" class="text-center border rounded" style="position:relative; overflow:hidden;">
            {% if template.image_path %}
              <img id="templateImage"
                   src="{{ url_for('static', filename='templates/' + template.image_path) }}"
                   alt="{{ template.name }}"
                   class="img-fluid"
                   style="max-height:700px; cursor:crosshair;"
                   />
            {% else %}
              <div class="p-5 text-muted">No image assigned to this template.</div>
            {% endif %}
          </div>

          <div id="clickCoords" class="mt-2 text-muted small"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">Fields (visual text placeholders)</h5>
          <div id="fieldsList" class="mb-3">
            <!-- JS populates existing fields -->
          </div>

          <hr />

          <h6 class="mb-2">Add / Edit Field</h6>
          <form id="fieldForm" onsubmit="return false;">
            <input type="hidden" id="editIndex" value="-1" />

            <div class="mb-2">
              <label class="form-label">Field name (key)</label>
              <input id="fieldName" class="form-control" placeholder="e.g. student_name" />
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label">X</label>
                <input id="fieldX" class="form-control" type="number" />
              </div>
              <div class="col-6">
                <label class="form-label">Y</label>
                <input id="fieldY" class="form-control" type="number" />
              </div>
            </div>

            <div class="row g-2 mb-2">
              <div class="col-6">
                <label class="form-label">Font size</label>
                <input id="fieldFont" class="form-control" type="number" value="24" />
              </div>
              <div class="col-6">
                <label class="form-label">Align</label>
                <select id="fieldAlign" class="form-select">
                  <option value="left">left</option>
                  <option value="center">center</option>
                  <option value="right">right</option>
                </select>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Color (hex)</label>
              <input id="fieldColor" class="form-control" placeholder="#000000" />
            </div>

            <div class="d-flex gap-2">
              <button id="addUpdateBtn" class="btn btn-primary">Add field</button>
              <button id="clearBtn" class="btn btn-outline-secondary" type="button">Clear</button>
            </div>
          </form>
        </div>
      </div>

      <div class="card">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <strong class="me-2">Actions</strong>
            <div class="small text-muted">Save will write fields to DB for this template.</div>
          </div>

          <div>
            <button id="saveBtn" class="btn btn-success" onclick="builderSave()">Save</button>
            <a href="{{ url_for('admin_templates') }}" class="btn btn-outline-secondary ms-2">Cancel</a>
          </div>
        </div>
      </div>

      <div id="alertPlaceholder" class="mt-3"></div>
    </div>
  </div>
</div>

<script>
const existingFields = {{ fields | tojson | safe }};
const templateId = {{ template.id }};

function showAlert(msg, type = 'info') {
  const el = document.getElementById('alertPlaceholder');
  el.innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
  setTimeout(()=> el.innerHTML = '', 3500);
}

// fields working array
let fields = existingFields.map(f => ({...f}));

// render fields list
function refreshFieldsList(){
  const list = document.getElementById('fieldsList');
  list.innerHTML = '';
  fields.forEach((f,i) => {
    const d = document.createElement('div');
    d.className = 'd-flex justify-content-between align-items-center mb-1';
    d.innerHTML = `<div><strong>${f.name}</strong> <span class="text-muted small">(${f.x},${f.y})</span></div>
                   <div>
                     <button class="btn btn-sm btn-outline-primary me-1" onclick="editField(${i})">Edit</button>
                     <button class="btn btn-sm btn-outline-danger" onclick="deleteField(${i})">Del</button>
                   </div>`;
    list.appendChild(d);
  });
}
refreshFieldsList();

const img = document.getElementById('templateImage');
if (img) {
  img.addEventListener('click', function(evt){
    const rect = img.getBoundingClientRect();
    const x = Math.round(evt.clientX - rect.left);
    const y = Math.round(evt.clientY - rect.top);
    document.getElementById('fieldX').value = x;
    document.getElementById('fieldY').value = y;
    document.getElementById('clickCoords').innerText = `Clicked at: ${x}, ${y}`;
  });
}

document.getElementById('addUpdateBtn').addEventListener('click', function(){
  const idx = parseInt(document.getElementById('editIndex').value, 10);
  const name = document.getElementById('fieldName').value.trim();
  const x = parseInt(document.getElementById('fieldX').value || 0, 10);
  const y = parseInt(document.getElementById('fieldY').value || 0, 10);
  const font_size = parseInt(document.getElementById('fieldFont').value || 24, 10);
  const color = document.getElementById('fieldColor').value || '#000000';
  const align = document.getElementById('fieldAlign').value || 'left';
  if (!name) { showAlert('Field name required','danger'); return; }

  const payload = { name, x, y, font_size, color, align };
  if (idx >= 0 && fields[idx]) {
    fields[idx] = payload;
    document.getElementById('editIndex').value = -1;
    document.getElementById('addUpdateBtn').innerText = 'Add field';
  } else {
    fields.push(payload);
  }

  // reset form
  document.getElementById('fieldForm').reset();
  document.getElementById('fieldFont').value = 24;
  document.getElementById('fieldColor').value = '#000000';
  refreshFieldsList();
});

document.getElementById('clearBtn').addEventListener('click', function(){
  document.getElementById('fieldForm').reset();
  document.getElementById('editIndex').value = -1;
  document.getElementById('addUpdateBtn').innerText = 'Add field';
});

function editField(i){
  const f = fields[i];
  document.getElementById('editIndex').value = i;
  document.getElementById('fieldName').value = f.name;
  document.getElementById('fieldX').value = f.x;
  document.getElementById('fieldY').value = f.y;
  document.getElementById('fieldFont').value = f.font_size || 24;
  document.getElementById('fieldColor').value = f.color || '#000000';
  document.getElementById('fieldAlign').value = f.align || 'left';
  document.getElementById('addUpdateBtn').innerText = 'Update field';
}

function deleteField(i){
  if (!confirm('Delete this field?')) return;
  fields.splice(i,1);
  refreshFieldsList();
}

// POST helper with JSON and fallback
async function postTo(url, bodyObj) {
  try {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(bodyObj),
    });
    const data = await r.json().catch(()=>({}));
    return { ok: r.ok, status: r.status, data };
  } catch (e) {
    console.warn("JSON POST failed", e);
  }

  // fallback: form encoded
  try {
    const form = new URLSearchParams();
    form.append("fields", JSON.stringify(bodyObj.fields || []));
    const r2 = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: form.toString(),
    });
    const data2 = await r2.json().catch(()=>({}));
    return { ok: r2.ok, status: r2.status, data: data2 };
  } catch (e2) {
    console.warn("Form POST failed", e2);
    return { ok: false, status: 0, data: {} };
  }
}

async function builderSave() {
  const payload = { fields };
  const btn = document.getElementById('saveBtn');
  btn.disabled = true;
  btn.innerText = 'Saving...';

  const endpoints = [
    `/admin/template/${templateId}/builder`,
    `/admin/templates/${templateId}/fields`
  ];

  let lastErr = null;
  for (const ep of endpoints) {
    try {
      const res = await postTo(ep, payload);
      if (res.ok && res.data && (res.data.status === 'ok' || res.data.status === 'success')) {
        showAlert('Fields saved successfully', 'success');
        setTimeout(()=> location.reload(), 700);
        return;
      } else {
        lastErr = res;
        if (res.status === 404) continue;
      }
    } catch (err) {
      lastErr = err;
    }
  }

  showAlert('Save failed. See server logs.', 'danger');
  btn.disabled = false;
  btn.innerText = 'Save';
}
</script>
{% endblock %}

