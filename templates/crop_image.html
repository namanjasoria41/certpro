{% extends "base.html" %}
{% block title %}Crop Image{% endblock %}

{% block extra_css %}
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
<style>
.crop-container {
  max-width: 420px;
  margin: auto;
}
#cropImage {
  max-width: 100%;
  display: none;
}
</style>
{% endblock %}

{% block content %}
<div class="crop-container">

  <h4 class="text-center mb-3">Crop {{ field|capitalize }}</h4>

  <input type="file" id="fileInput" class="form-control mb-3" accept="image/*">

  <img id="cropImage">

  <button id="saveBtn" class="btn btn-success w-100 mt-3" disabled>
    Save Image
  </button>

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper;

const fileInput = document.getElementById("fileInput");
const image = document.getElementById("cropImage");
const saveBtn = document.getElementById("saveBtn");

fileInput.addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = ev => {
    image.src = ev.target.result;
    image.style.display = "block";

    if (cropper) cropper.destroy();

    cropper = new Cropper(image, {
      aspectRatio: "{{ shape }}" === "circle" ? 1 : NaN,
      viewMode: 1,
      autoCropArea: 1
    });

    saveBtn.disabled = false;
  };
  reader.readAsDataURL(file);
});

saveBtn.onclick = () => {
  const canvas = cropper.getCroppedCanvas({ imageSmoothingQuality: "high" });

  fetch("{{ url_for('save_cropped_image', template_id=template.id, field=field) }}", {
    method: "POST",
    headers: { "Content-Type": "text/plain" },
    body: canvas.toDataURL("image/png")
  })
  .then(r => r.json())
  .then(() => window.history.back());
};
</script>
{% endblock %}
